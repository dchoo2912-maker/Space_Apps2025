<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mission Vista ‚Äî Solar System Explorer</title>

<!-- Tailwind (UI only) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<!-- OpenSeadragon (for the simple deep-zoom tab) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.1/openseadragon.min.css" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.1/openseadragon.min.js" crossorigin="anonymous"></script>

<style>
:root{--bg:#0b1020;--panel:#111936;--ink:#eaf2ff;--muted:#9fb0d3;--accent:#7cc7ff;--glass:rgba(20,20,40,.6)}
html,body{height:100%;margin:0;background: radial-gradient(100% 80% at 50% 0%, #0a0a20 0%, #000 80%);color:var(--ink);font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
a,a:visited{color:#89d4ff}
header{backdrop-filter:blur(10px);background-color:rgba(10,10,30,0.4);position:sticky;top:0;z-index:50;}
.starfield{position:fixed;inset:0;z-index:-10;background:radial-gradient(circle at 50% 20%,#1a1a3d,#000);background-size:cover;animation:stars 200s linear infinite;}
@keyframes stars{from{background-position:0 0;}to{background-position:10000px 10000px;}}
.glow-text{background:linear-gradient(90deg,#70b8ff,#b597ff);-webkit-background-clip:text;color:transparent;animation:glow 3s ease-in-out infinite alternate;}
@keyframes glow{from{text-shadow:0 0 10px #70b8ff44;}to{text-shadow:0 0 25px #b597ffaa;}}
.hero-btn{background:linear-gradient(90deg,#3b82f6,#1e40af);color:#fff;padding:1rem 3rem;border-radius:9999px;font-size:1.1rem;font-weight:600;transition:all .3s;box-shadow:0 0 20px #3b82f655,0 0 40px #1e40af33;}
.hero-btn:hover{transform:scale(1.06);box-shadow:0 0 25px #3b82f6aa,0 0 60px #1e40afaa;background:linear-gradient(90deg,#2563eb,#1d4ed8);}
.glass{background:var(--glass);backdrop-filter:blur(8px);border:1px solid rgba(120,120,200,.15)}
.btn{padding:.45rem .65rem;border-radius:.75rem;font-size:.85rem;background:rgba(120,130,255,.14);border:1px solid rgba(120,130,255,.25);line-height:1}
.btn:hover{background:rgba(120,130,255,.22)}
.btn-primary{background:rgba(123,140,255,.25);border-color:rgba(123,140,255,.5)}
.nav-top-fix{z-index:9999!important;pointer-events:auto!important;}
#planet-canvas{width:100%;height:100%;display:block}
#planet-hud{position:absolute;left:12px;bottom:12px;color:var(--muted);font-size:12px}
#viewer{position:absolute;inset:0;z-index:10;}
#inspectOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99999;}
#inspectPanel{width:min(92vw,1100px);height:min(86vh,720px);background:#0a0f24;border:1px solid rgba(255,255,255,.12);border-radius:16px;display:flex;flex-direction:column;}
#inspectHeader{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.12);}
#inspectHeader .title{font-weight:700;}
#inspectBody{flex:1;position:relative;background:#000;border-radius:0 0 16px 16px;overflow:hidden;}
#inspectCanvas{position:absolute;inset:0;}
</style>
</head>
<body>
<div class="starfield"></div>

<header class="p-6 flex justify-between items-center">
  <h1 class="text-2xl font-bold tracking-wider glow-text">MISSION VISTA</h1>
  <nav class="space-x-6">
    <button data-goto="home" class="hover:text-blue-400" aria-label="Home">Home</button>
    <button data-goto="explorer" class="hover:text-blue-400" aria-label="Solar System">Solar System</button>
  </nav>
</header>

<main id="home" class="block">
  <section class="min-h-screen flex flex-col items-center justify-center text-center px-6">
    <h2 class="text-5xl md:text-6xl font-bold mb-6 glow-text">See Beyond Pixels</h2>
    <p class="max-w-2xl text-lg text-gray-300 mb-10">
      Your phone captures millions of pixels. NASA captures trillions.<br/>
      <span class="text-blue-400">Mission Vista</span> transforms real NASA datasets into immersive visual experiences.
    </p>
    <button data-goto="explorer" class="hero-btn" aria-label="Enter the Solar System">üöÄ Enter the Solar System ‚Üí</button>
  </section>

  <section class="py-24 bg-black/30">
    <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-12 items-center px-6">
      <div class="text-left space-y-6">
        <h3 class="text-3xl font-semibold mb-2">Our Project</h3>
        <p>Click <em>Solar System</em> to try our two modes: <span class="font-semibold">3D Planets</span> and a minimal <span class="font-semibold">Deep Zoom</span> viewer.</p>
        <div><button data-goto="explorer" class="btn mt-2">Open the Solar System Explorer ‚Üí</button></div>
      </div>
    </div>
  </section>
</main>

<section id="explorer" class="hidden relative">
  <div class="glass fixed top-3 left-1/2 -translate-x-1/2 nav-top-fix rounded-2xl px-3 py-2 z-[9999] flex items-center gap-3">
    <button data-goto="home" class="btn" title="Back to Home">‚Üê Home</button>
    <div class="font-semibold tracking-wide">Space Explorer</div>
    <div class="ml-2 flex gap-2">
      <button id="tabPlanets" class="btn btn-primary">3D Planets</button>
      <button id="tabZoom" class="btn">Deep Zoom</button>
    </div>
    <div class="ml-2 flex items-center gap-2">
      <label class="text-xs opacity-80" for="bodySelect">Body</label>
      <select id="bodySelect" class="bg-transparent border border-slate-600 rounded-xl p-1 px-2 text-xs">
        <option>Mercury</option><option>Venus</option><option>Earth</option><option>Mars</option>
        <option>Jupiter</option><option selected>Saturn</option><option>Uranus</option><option>Neptune</option>
      </select>
    </div>
    <button id="inspectBtn" class="btn hidden">Inspect</button>
    <button id="stopFollowBtn" class="btn hidden">Stop following</button>
  </div>

  <!-- 3D Planets view -->
  <div class="w-full h-screen grid grid-cols-1" id="view-planets">
    <div id="planet-wrap" class="relative">
      <canvas id="planet-canvas"></canvas>
      <div id="planet-hud">Drag = orbit ‚Ä¢ Scroll = zoom ‚Ä¢ Double-click empty space to reset</div>
      <div id="chooser" class="absolute top-4 right-4 z-20 flex gap-2 flex-wrap max-w-[50vw]"></div>
      <div class="absolute top-4 left-4 z-20 text-sm opacity-90 bg-black/40 px-3 py-2 rounded-xl border border-white/10">
        <div id="planetName" class="font-semibold">Click a planet or Moon</div>
        <div id="stats" class="text-xs opacity-90"></div>
      </div>
    </div>
  </div>

  <!-- Deep Zoom view -->
  <div class="w-full h-screen relative overflow-hidden hidden" id="view-zoom">
    <div class="glass absolute left-3 top-16 bottom-3 w-64 z-30 rounded-2xl p-3 flex flex-col gap-3">
      <div class="text-sm font-semibold mb-1">Layers</div>
      <div class="grid grid-cols-1 gap-2">
        <button class="btn btn-primary" data-layer="earth">Blue Marble</button>
        <button class="btn" data-layer="mars">Mars (Viking)</button>
        <button class="btn" data-layer="moon">Moon (LRO)</button>
      </div>
      <hr class="border-slate-700/50 my-1">
      <div class="text-[11px] opacity-70">Drag to move ‚Ä¢ Scroll to zoom</div>
    </div>
    <div id="viewer"></div>
  </div>
</section>

<footer class="p-6 text-center text-gray-500 text-sm">
  Built for the NASA Space Apps Challenge üöÄ
</footer>

<!-- OrbitControls-lite (inline) -->
<script>
class OrbitControlsLite {
  constructor(object, domElement){
    this.object = object; this.domElement = domElement || document; this.enabled = true;
    this.target = new THREE.Vector3(); this.enablePan = false; this.enableDamping = true; this.dampingFactor = 0.06;
    this.minDistance = 5; this.maxDistance = 900; this.rotateSpeed = 0.0022; this.zoomSpeed = 1.1;
    this._spherical = new THREE.Spherical(); this._sphericalDelta = new THREE.Spherical(0,0,0);
    this._offset = new THREE.Vector3(); this._state='none'; this._pointer=new THREE.Vector2(); this._pointerOld=new THREE.Vector2();
    this._phiMin = 1e-3; this._phiMax = Math.PI - 1e-3;
    this._onMouseDown=(e)=>{ if(!this.enabled) return; if(e.button===0){ this._state='rotate'; this._pointer.set(e.clientX,e.clientY); this._pointerOld.copy(this._pointer); this.domElement.setPointerCapture?.(e.pointerId);} };
    this._onMouseMove=(e)=>{ if(!this.enabled) return; if(this._state==='rotate'){ this._pointer.set(e.clientX,e.clientY);
      const dx=this._pointer.x-this._pointerOld.x, dy=this._pointer.y-this._pointerOld.y;
      this._sphericalDelta.theta -= dx*this.rotateSpeed; this._sphericalDelta.phi -= dy*this.rotateSpeed;
      this._pointerOld.copy(this._pointer);} };
    this._onMouseUp=()=>{ this._state='none'; };
    this._onWheel=(e)=>{ if(!this.enabled) return; e.preventDefault(); const s=(e.deltaY<0)?(1/this.zoomSpeed):this.zoomSpeed; this._zoom(s); };
    this.domElement.addEventListener('pointerdown', this._onMouseDown, {passive:false});
    window.addEventListener('pointermove', this._onMouseMove, {passive:false});
    window.addEventListener('pointerup', this._onMouseUp, {passive:false});
    this.domElement.addEventListener('wheel', this._onWheel, {passive:false});
    this._updateSphericalFromObject();
  }
  _updateSphericalFromObject(){ this._offset.copy(this.object.position).sub(this.target); this._spherical.setFromVector3(this._offset);
    this._spherical.radius = Math.min(Math.max(this._spherical.radius, this.minDistance), this.maxDistance); }
  _zoom(scale){ this._spherical.radius*=scale; this._spherical.radius=Math.min(Math.max(this._spherical.radius,this.minDistance),this.maxDistance); }
  update(){
    if(this.enableDamping){
      this._spherical.theta += this._sphericalDelta.theta*this.dampingFactor;
      this._spherical.phi   += this._sphericalDelta.phi  *this.dampingFactor;
      this._sphericalDelta.theta *= (1-this.dampingFactor);
      this._sphericalDelta.phi   *= (1-this.dampingFactor);
    }else{
      this._spherical.theta += this._sphericalDelta.theta;
      this._spherical.phi   += this._sphericalDelta.phi;
      this._sphericalDelta.set(0,0,0);
    }
    this._spherical.phi = Math.max(this._phiMin, Math.min(this._phiMax, this._spherical.phi));
    this._spherical.radius = Math.min(Math.max(this._spherical.radius, this.minDistance), this.maxDistance);
    this._offset.setFromSpherical(this._spherical); this.object.position.copy(this.target).add(this._offset); this.object.lookAt(this.target);
  }
  dispose(){
    this.domElement.removeEventListener('pointerdown', this._onMouseDown);
    window.removeEventListener('pointermove', this._onMouseMove);
    window.removeEventListener('pointerup', this._onMouseUp);
    this.domElement.removeEventListener('wheel', this._onWheel);
  }
}
THREE.EventDispatcher && Object.assign(OrbitControlsLite.prototype, THREE.EventDispatcher.prototype);
THREE.OrbitControls = OrbitControlsLite;
</script>

<!-- App -->
<script>
// ---------- SPA NAV ----------
function showSection(id){
  document.getElementById('home').classList.toggle('hidden', id!=='home');
  document.getElementById('explorer').classList.toggle('hidden', id!=='explorer');
  if(id==='explorer'){ setTimeout(()=>{ resizeRendererToDisplaySize(); },0); }
}
document.querySelectorAll('[data-goto]').forEach(el=>{
  el.addEventListener('click', ()=>{ const id=el.getAttribute('data-goto'); showSection(id); if(id==='explorer'){ showPlanetsTab(); } });
});

// ---------- THREE SETUP ----------
const canvas = document.getElementById('planet-canvas');
const renderer = new THREE.WebGLRenderer({ antialias:true, canvas });
renderer.setSize(canvas.clientWidth||innerWidth, canvas.clientHeight||innerHeight, false);
renderer.setPixelRatio(Math.min(devicePixelRatio||1, 2));
if('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace; else renderer.outputEncoding = THREE.sRGBEncoding;
renderer.toneMapping = THREE.ACESFilmicToneMapping;

function resizeRendererToDisplaySize(){
  const w = canvas.clientWidth || innerWidth, h = canvas.clientHeight || innerHeight;
  const need = canvas.width !== Math.floor(w*renderer.getPixelRatio()) || canvas.height !== Math.floor(h*renderer.getPixelRatio());
  if(need){ renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
}
window.addEventListener('resize', resizeRendererToDisplaySize);

const scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000);
const camera = new THREE.PerspectiveCamera(60, (canvas.clientWidth||innerWidth)/(canvas.clientHeight||innerHeight), 0.1, 5000);
camera.position.set(0,30,110);
const controls = new THREE.OrbitControls(camera, canvas);
controls.enableDamping = true; controls.dampingFactor = 0.06; controls.enablePan = false;
const BASE_MIN_DISTANCE = 5; controls.minDistance = BASE_MIN_DISTANCE; controls.maxDistance = 900;

// Lights + Sun
scene.add(new THREE.AmbientLight(0xffffff, 0.38));
scene.add(new THREE.HemisphereLight(0xbfdfff, 0x080820, 0.28));
const sunLight = new THREE.PointLight(0xffffff, 2.1, 0); sunLight.position.set(0,0,0); scene.add(sunLight);
const sun = new THREE.Mesh(new THREE.SphereGeometry(3, 64, 48), new THREE.MeshBasicMaterial({color:0xffffff})); scene.add(sun);

// UI refs
const planetNameEl = document.getElementById('planetName'); const statsEl = document.getElementById('stats');
const inspectBtn = document.getElementById('inspectBtn'); const stopFollowBtn = document.getElementById('stopFollowBtn');
function setStats(t){ statsEl.textContent = t||''; } function fmt(n){ return typeof n==='number'? n.toLocaleString() : n; }

// ---------- Textures (local-first with Wikimedia fallbacks) ----------
const texLoader = new THREE.TextureLoader(); texLoader.crossOrigin = 'anonymous';
function maxAniso(){ return renderer.capabilities.getMaxAnisotropy?.() || 8; }

function loadFromList(urls, ok, fail){
  let i=0;
  const tryNext=()=>{ if(i>=urls.length){ console.warn("All texture URLs failed:", urls); fail&&fail(); return; }
    const u=urls[i++]; console.log("Loading texture:", u);
    texLoader.load(u, t=>{ console.log("‚úÖ Loaded:", u);
      t.anisotropy=maxAniso(); if('colorSpace'in t) t.colorSpace=THREE.SRGBColorSpace; else t.encoding=THREE.sRGBEncoding;
      ok(t,u);
    }, undefined, (err)=>{ console.warn("‚ùå Failed:", u, err); tryNext(); });
  }; tryNext();
}
function colorTexture(hex=0x777777){ const c=document.createElement('canvas'); c.width=c.height=2; const x=c.getContext('2d'); x.fillStyle='#'+hex.toString(16).padStart(6,'0'); x.fillRect(0,0,2,2); const t=new THREE.CanvasTexture(c); t.anisotropy=maxAniso(); if('colorSpace'in t) t.colorSpace=THREE.SRGBColorSpace; else t.encoding=THREE.sRGBEncoding; return t; }

/* Local same-origin first; if missing, use Wikimedia */
const TEXSRC = {
  mercury: ["images/mercury.jpg","https://upload.wikimedia.org/wikipedia/commons/2/2c/Mercury_global_map_MESSENGER_mosaic_enhanced_color.jpg"],
  venus:   ["images/venus.jpg","https://upload.wikimedia.org/wikipedia/commons/8/85/Venus_RGB_Map_1800x900.jpg"],
  earth:   ["images/earth.jpg","https://upload.wikimedia.org/wikipedia/commons/5/5f/Blue_Marble_2002.png"],
  moon:    ["images/moon.jpg","https://upload.wikimedia.org/wikipedia/commons/5/5e/Moon_map_LRO_WAC_Poles_1k.jpg"],
  mars:    ["images/mars.jpg","https://upload.wikimedia.org/wikipedia/commons/0/02/Mars_Viking_MDIM21_1km_plus_poles.jpg"],
  jupiter: ["images/jupiter.jpg","https://upload.wikimedia.org/wikipedia/commons/5/5a/Jupiter_map_by_Askaniy.jpg"],
  saturn:  ["images/saturn.jpg","https://upload.wikimedia.org/wikipedia/commons/f/f0/Saturn_map_by_Askaniy.png"],
  uranus:  ["images/uranus.jpg","https://upload.wikimedia.org/wikipedia/commons/3/3d/Solarsystemscope_texture_2k_uranus.jpg"],
  neptune: ["images/neptune.jpg","https://upload.wikimedia.org/wikipedia/commons/5/56/Solarsystemscope_texture_2k_neptune.jpg"]
};
function textureCandidatesFor(key){ return TEXSRC[key]||[]; }

// ---------- System (with axial spin) ----------
const planetDefs = [
  {name:'Mercury', radius:0.38, dist:5, orbitSpeed:0.040, tiltDeg:0.03, key:'mercury', color:0x9aa0a6, spinHours:1407.5},
  {name:'Venus', radius:0.95, dist:7, orbitSpeed:0.015, tiltDeg:177.4, key:'venus', color:0xe5bd9a, spinHours:-5832.5},
  {name:'Earth', radius:1.00, dist:10, orbitSpeed:0.010, tiltDeg:23.4, key:'earth', color:0x2e74c8, spinHours:24},
  {name:'Mars', radius:0.53, dist:15, orbitSpeed:0.0053, tiltDeg:25.2, key:'mars', color:0xb44b32, spinHours:24.6},
  {name:'Jupiter', radius:1.50, dist:25, orbitSpeed:0.00084, tiltDeg:3.1, key:'jupiter', color:0xd2b48c, spinHours:9.9},
  {name:'Saturn', radius:1.20, dist:35, orbitSpeed:0.00034, tiltDeg:26.7, key:'saturn', color:0xead6a4, spinHours:10.7},
  {name:'Uranus', radius:1.00, dist:45, orbitSpeed:0.00012, tiltDeg:97.8, key:'uranus', color:0x7fcfd6, spinHours:-17.2},
  {name:'Neptune', radius:1.00, dist:55, orbitSpeed:0.00006, tiltDeg:28.3, key:'neptune', color:0x3455d1, spinHours:16.1}
];
const INFO = {
  Mercury:{radiusKm:2440,yearDays:88,dayHours:1407.5,moons:0,summary:"Cratered, airless world."},
  Venus:{radiusKm:6052,yearDays:225,dayHours:5832.5,moons:0,summary:"Hottest planet; thick clouds; retrograde spin."},
  Earth:{radiusKm:6371,yearDays:365,dayHours:24,moons:1,summary:"Oceans, continents, dynamic weather."},
  Mars:{radiusKm:3390,yearDays:687,dayHours:24.6,moons:2,summary:"Rust deserts, canyons, shield volcanoes."},
  Jupiter:{radiusKm:69911,yearDays:4333,dayHours:9.9,moons:"80+",summary:"Banded giant with jet streams and storms."},
  Saturn:{radiusKm:58232,yearDays:10759,dayHours:10.7,moons:"80+",summary:"Pale gas giant with dramatic rings."},
  Uranus:{radiusKm:25362,yearDays:30687,dayHours:17.2,moons:27,summary:"Sideways ice giant; smooth cyan bands."},
  Neptune:{radiusKm:24622,yearDays:60190,dayHours:16.1,moons:14,summary:"Deep blue ice giant with fierce winds."},
  Moon:{radiusKm:1737,yearDays:27.3,dayHours:655.7,moons:0,summary:"Tidally locked ‚Äî same face toward Earth.",parent:"Earth"}
};

// Orbit rings
function addOrbitRing(dist){
  const ring = new THREE.Mesh(
    new THREE.RingGeometry(dist-0.03, dist+0.03, 256),
    new THREE.MeshBasicMaterial({ color: 0x7BDFFF, side: THREE.DoubleSide, opacity: 0.18, transparent: true })
  ); ring.rotation.x=-Math.PI/2; scene.add(ring);
}

// Saturn rings texture
function makeHighResRingsTexture(size=2048){
  const c=document.createElement('canvas'); c.width=size; c.height=size; const ctx=c.getContext('2d');
  const cx=size/2, cy=size/2, R=size/2; const inner=0.45*R, outer=0.95*R; const img=ctx.createImageData(size,size);
  for(let y=0;y<size;y++) for(let x=0;x<size;x++){
    const dx=x-cx, dy=y-cy; const rr=Math.hypot(dx,dy); const i=(y*size+x)*4;
    if(rr<inner||rr>outer){ img.data[i+3]=0; continue; }
    const t=(rr-inner)/(outer-inner), fine=Math.sin(t*1200)*.5+.5, med=Math.sin(t*60+t*10)*.5+.5;
    const base=.62+.34*med, shade=base*(.84+.16*fine), edge=Math.min(1,Math.max(0,Math.min(t*6,(1-t)*6)));
    img.data[i]=Math.round(235*shade*edge); img.data[i+1]=Math.round(225*shade*edge); img.data[i+2]=Math.round(205*shade*edge); img.data[i+3]=Math.round(245*edge);
  }
  ctx.putImageData(img,0,0); const tex=new THREE.CanvasTexture(c); tex.anisotropy=maxAniso(); return tex;
}

const planets=[], clickables=[], ringsToFollow=[], planetMeshesByName={}; let earthMesh=null;
function phong(){ return new THREE.MeshPhongMaterial({ color:0xffffff, specular:0x222222, shininess:10 }); }

const SPIN_SCALE = 0.5 / (24*3600); // visual scale for axial spin

function addPlanet(def){
  addOrbitRing(def.dist);
  const mesh = new THREE.Mesh(new THREE.SphereGeometry(def.radius,64,48), phong());
  mesh.rotation.z = THREE.MathUtils.degToRad(def.tiltDeg);
  mesh.userData = {
    type:'planet', name:def.name, dist:def.dist,
    theta:Math.random()*Math.PI*2, orbitSpeed:def.orbitSpeed, radius:def.radius,
    spinRadPerSec:(2*Math.PI/(Math.abs(def.spinHours||24)*3600))*(def.spinHours<0?-1:1)*SPIN_SCALE
  };
  mesh.position.set(def.dist*Math.cos(mesh.userData.theta),0,def.dist*Math.sin(mesh.userData.theta));
  scene.add(mesh); planets.push(mesh); clickables.push(mesh); planetMeshesByName[def.name]=mesh; if(def.name==='Earth') earthMesh=mesh;

  loadFromList(textureCandidatesFor(def.key), (t)=>{ mesh.material.map=t; mesh.material.bumpMap=t; mesh.material.bumpScale=0.02; mesh.material.needsUpdate=true; },
    ()=>{ mesh.material.map=colorTexture(def.color); mesh.material.needsUpdate=true; });

  if(def.name==='Saturn'){
    const inner=def.radius*2.10, outer=def.radius*3.85;
    const ringGeo=new THREE.RingGeometry(inner,outer,1024,1);
    const ringMat=new THREE.MeshBasicMaterial({transparent:true,depthWrite:false,side:THREE.DoubleSide});
    const ring=new THREE.Mesh(ringGeo,ringMat); ring.rotation.x=-Math.PI/2; ring.position.copy(mesh.position);
    scene.add(ring); ringsToFollow.push({ring,parent:mesh});
    ringMat.map=makeHighResRingsTexture(2048); ringMat.opacity=1.0; ringMat.needsUpdate=true;
  }
}
planetDefs.forEach(addPlanet);

// Moon
const moon = new THREE.Mesh(new THREE.SphereGeometry(0.27,64,48), phong());
moon.userData={type:'moon',name:'Moon',parent:null,distFromParent:2.5,theta:Math.random()*Math.PI*2,orbitSpeed:0.08,radius:0.27,tiltDeg:6.7,spinRadPerSec:(2*Math.PI/(655.7*3600))*SPIN_SCALE};
moon.rotation.z = THREE.MathUtils.degToRad(moon.userData.tiltDeg);
scene.add(moon); clickables.push(moon);
loadFromList(textureCandidatesFor('moon'), t=>{ moon.material.map=t; moon.material.bumpMap=t; moon.material.bumpScale=0.03; moon.material.needsUpdate=true; }, ()=>{ moon.material.map=colorTexture(0xaaaaaa); moon.material.needsUpdate=true; });

// Safety buffer
function getEffectiveRadius(obj){ return (obj?.userData?.radius)||1; }
function enforceSafetyBufferFor(body){ const r=getEffectiveRadius(body); controls.minDistance=Math.max(r*1.15,2); }
function clampCameraToSafety(){
  let nearest=null, best=Infinity; const tgt=controls.target; const bodies=[...planets,moon];
  for(const b of bodies){ const d=b.position.distanceTo(tgt); if(d<best){best=d; nearest=b;} }
  if(!nearest){ controls.minDistance=BASE_MIN_DISTANCE; return; }
  const r=getEffectiveRadius(nearest); const safe=Math.max(r*1.15,2);
  controls.minDistance=Math.max(safe,BASE_MIN_DISTANCE);
  const camDir=new THREE.Vector3().subVectors(camera.position,tgt); const dist=camDir.length();
  if(dist<controls.minDistance){ camDir.normalize(); camera.position.copy(tgt.clone().add(camDir.multiplyScalar(controls.minDistance))); }
}
controls.addEventListener && controls.addEventListener('change', clampCameraToSafety);

// Quick chooser
const chooser=document.getElementById('chooser');
['Mercury','Venus','Earth','Moon','Mars','Jupiter','Saturn','Uranus','Neptune'].forEach(n=>{
  const b=document.createElement('button'); b.className='btn'; b.textContent=n;
  b.onclick=()=>{ const m=(n==='Moon')?moon:planetMeshesByName[n]; if(m) onSelectBody(m); };
  chooser.appendChild(b);
});

// Select/follow
let following=false, followedBody=null, prevTarget=new THREE.Vector3(), isFocusing=false;
function startFocusAndFollow(body){
  followedBody=body; following=false; isFocusing=true; enforceSafetyBufferFor(body);
  const r=body.userData.radius||1; const desired=body.position.clone().add(new THREE.Vector3(0,r*3,r*5));
  const start=camera.position.clone(), st=controls.target.clone(), end=body.position.clone(); let t=0;
  (function anim(){ t+=0.02; const e=t>=1?1:1-Math.pow(1-t,3);
    camera.position.lerpVectors(start,desired,e); controls.target.lerpVectors(st,end,e);
    if(e<1) requestAnimationFrame(anim); else { prevTarget.copy(body.position); following=true; isFocusing=false; stopFollowBtn.classList.remove('hidden'); } })();
}
function updateFollowCamera(){ if(!following||!followedBody||isFocusing) return; const nt=followedBody.position, delta=new THREE.Vector3().subVectors(nt,prevTarget); camera.position.add(delta); controls.target.copy(nt); prevTarget.copy(nt); }
function onSelectBody(body){
  const name=body.userData?.name||'Object'; planetNameEl.textContent=name;
  const d=INFO[name]; if(d) setStats(`${d.summary} ‚Ä¢ Radius: ${fmt(d.radiusKm)} km ‚Ä¢ Year: ${fmt(d.yearDays)} days ‚Ä¢ Day: ${fmt(d.dayHours)} h ‚Ä¢ Moons: ${fmt(d.moons)}`);
  inspectBtn.classList.remove('hidden'); startFocusAndFollow(body);
}
stopFollowBtn.onclick=()=>{ following=false; followedBody=null; stopFollowBtn.classList.add('hidden'); };

// Raycast select
const raycaster=new THREE.Raycaster(), mouse=new THREE.Vector2();
canvas.addEventListener('click',(e)=>{ const rect=canvas.getBoundingClientRect(); const x=(e.clientX-rect.left)/rect.width, y=(e.clientY-rect.top)/rect.height;
  mouse.x=x*2-1; mouse.y=-(y*2-1); raycaster.setFromCamera(mouse,camera); const hits=raycaster.intersectObjects(clickables,true); if(!hits.length) return; onSelectBody(hits[0].object); });
// Reset
canvas.addEventListener('dblclick',()=>{ following=false; followedBody=null; stopFollowBtn.classList.add('hidden'); camera.position.set(0,30,110); controls.target.set(0,0,0); controls.minDistance=BASE_MIN_DISTANCE; planetNameEl.textContent='Click a planet or Moon'; setStats(''); inspectBtn.classList.add('hidden'); });

// Animation
const clock=new THREE.Clock();
function updateOrbits(dt){
  planets.forEach(p=>{ const d=p.userData; d.theta += d.orbitSpeed*dt*60; const R=d.dist; p.position.set(R*Math.cos(d.theta),0,R*Math.sin(d.theta)); p.rotation.y += (d.spinRadPerSec||0)*dt; });
  ringsToFollow.forEach(({ring,parent})=> ring.position.copy(parent.position));
  if(earthMesh){ if(!moon.userData.parent) moon.userData.parent=earthMesh; moon.userData.theta += moon.userData.orbitSpeed*dt*60; const r=moon.userData.distFromParent;
    moon.position.set(earthMesh.position.x+r*Math.cos(moon.userData.theta),0,earthMesh.position.z+r*Math.sin(moon.userData.theta));
    moon.rotation.y += (moon.userData.spinRadPerSec||0)*dt; moon.lookAt(earthMesh.position);
  }
}
function animate(){ requestAnimationFrame(animate); const dt=clock.getDelta(); resizeRendererToDisplaySize(); updateOrbits(dt); updateFollowCamera(); clampCameraToSafety(); controls.update(); renderer.render(scene,camera); }
animate();

// Body select dropdown
const bodySelect=document.getElementById('bodySelect');
bodySelect.addEventListener('change',()=>{ const name=bodySelect.value; const mesh=planetMeshesByName[name]; if(mesh) onSelectBody(mesh); });

// Inspect modal
const inspectOverlay=document.createElement('div'); inspectOverlay.id='inspectOverlay'; inspectOverlay.innerHTML=`
  <div id="inspectPanel">
    <div id="inspectHeader">
      <div class="title" id="inspectTitle">Inspect</div>
      <div class="flex items-center gap-2">
        <label class="text-xs flex items-center gap-2"><input id="spinToggle" type="checkbox"/> Spin</label>
        <button id="resetInspectCam" class="btn" aria-label="Reset view">Reset view</button>
        <button id="closeInspect" class="btn" aria-label="Close">Close</button>
      </div>
    </div>
    <div id="inspectBody"><div id="inspectCanvas"></div></div>
  </div>`;
document.body.appendChild(inspectOverlay);
let inspRenderer,inspScene,inspCam,inspControls,inspMesh,inspRings=null,inspRAF=0,inspRadius=1;
const inspectTitle=inspectOverlay.querySelector('#inspectTitle'), spinToggle=inspectOverlay.querySelector('#spinToggle'), resetInspectCam=inspectOverlay.querySelector('#resetInspectCam'), closeInspect=inspectOverlay.querySelector('#closeInspect'), inspectCanvas=document.createElement('div');
inspectCanvas.id='inspectCanvas'; document.getElementById('inspectBody').appendChild(inspectCanvas);

function openInspect(name){
  inspectTitle.textContent=`Inspect: ${name}`; inspectOverlay.style.display='flex';
  if(!inspRenderer){
    inspRenderer=new THREE.WebGLRenderer({antialias:true}); inspRenderer.setPixelRatio(Math.min(devicePixelRatio||1,2));
    if('outputColorSpace'in inspRenderer) inspRenderer.outputColorSpace=THREE.SRGBColorSpace; else inspRenderer.outputEncoding=THREE.sRGBEncoding;
    inspRenderer.toneMapping=THREE.ACESFilmicToneMapping; inspRenderer.setSize(inspectCanvas.clientWidth,inspectCanvas.clientHeight); inspectCanvas.appendChild(inspRenderer.domElement);
    inspScene=new THREE.Scene(); inspScene.background=new THREE.Color(0x000000);
    inspCam=new THREE.PerspectiveCamera(60,inspectCanvas.clientWidth/inspectCanvas.clientHeight,0.01,2000); inspCam.position.set(0,0.8,2.2);
    inspControls=new THREE.OrbitControls(inspCam,inspRenderer.domElement); inspControls.enableDamping=true; inspControls.dampingFactor=0.06; inspControls.enablePan=false;
    inspScene.add(new THREE.AmbientLight(0xffffff,0.5)); const L=new THREE.DirectionalLight(0xffffff,1.0); L.position.set(5,2,8); inspScene.add(L);
    new ResizeObserver(()=>{ const w=inspectCanvas.clientWidth,h=inspectCanvas.clientHeight; inspRenderer.setSize(w,h); inspCam.aspect=w/h; inspCam.updateProjectionMatrix(); }).observe(inspectCanvas);
  }
  if(inspMesh){ inspScene.remove(inspMesh); inspMesh.geometry.dispose(); inspMesh.material.map?.dispose(); inspMesh.material.dispose(); inspMesh=null; }
  if(inspRings){ inspScene.remove(inspRings); inspRings.geometry.dispose(); inspRings.material.map?.dispose(); inspRings.material.dispose(); inspRings=null; }
  const rLookup={Mercury:.38,Venus:.95,Earth:1,Moon:.27,Mars:.53,Jupiter:1.5,Saturn:1.2,Uranus:1,Neptune:1}; inspRadius=rLookup[name]||1;
  inspMesh=new THREE.Mesh(new THREE.SphereGeometry(1,128,96),new THREE.MeshPhongMaterial({color:0xffffff,specular:0x222222,shininess:10}));
  const tilt={Mercury:.03,Venus:177.4,Earth:23.4,Mars:25.2,Jupiter:3.1,Saturn:26.7,Uranus:97.8,Neptune:28.3,Moon:6.7}[name]||0;
  inspMesh.rotation.z=THREE.MathUtils.degToRad(tilt); inspMesh.scale.setScalar(inspRadius); inspScene.add(inspMesh);
  const key=(name==='Moon')?'moon':name.toLowerCase(); const cands=textureCandidatesFor(key);
  loadFromList(cands,(t)=>{ t.anisotropy=maxAniso(); if('colorSpace'in t) t.colorSpace=THREE.SRGBColorSpace; else t.encoding=THREE.sRGBEncoding; inspMesh.material.map=t; inspMesh.material.bumpMap=t; inspMesh.material.bumpScale=0.02; inspMesh.material.needsUpdate=true; },()=>{});
  if(name==='Saturn'){ const inner=inspRadius*2.10, outer=inspRadius*3.85; const geo=new THREE.RingGeometry(inner,outer,2048,1); const mat=new THREE.MeshBasicMaterial({transparent:true,depthWrite:false,side:THREE.DoubleSide}); const ring=new THREE.Mesh(geo,mat); ring.rotation.x=-Math.PI/2; mat.map=makeHighResRingsTexture(4096); mat.opacity=1.0; mat.needsUpdate=true; inspRings=ring; inspScene.add(ring); }
  inspControls.minDistance=Math.max(inspRadius*1.1,0.25); inspControls.maxDistance=Math.max(inspRadius*15,8); inspControls.target.set(0,0,0); inspCam.position.set(0,inspRadius*0.8,inspRadius*2.2);
  spinToggle.checked=false;
  const tick=()=>{ inspRAF=requestAnimationFrame(tick); if(spinToggle.checked){ inspMesh.rotation.y+=0.01; } inspControls.update(); inspRenderer.render(inspScene,inspCam); };
  cancelAnimationFrame(inspRAF); tick();
}
document.getElementById('inspectBtn').addEventListener('click',()=>{ if(followedBody) openInspect(followedBody.userData?.name||'Object'); });
document.getElementById('inspectOverlay').addEventListener('click',(e)=>{ if(e.target.id==='inspectOverlay') document.getElementById('closeInspect').click(); });
document.getElementById('closeInspect').addEventListener('click',()=>{ document.getElementById('inspectOverlay').style.display='none'; cancelAnimationFrame(inspRAF); });
document.getElementById('resetInspectCam').addEventListener('click',()=>{ if(!inspControls) return; inspControls.target.set(0,0,0); inspCam.position.set(0,inspRadius*0.8,inspRadius*2.2); });

// Tabs + Deep Zoom
const viewPlanets=document.getElementById('view-planets');
const viewZoom=document.getElementById('view-zoom');
const tabPlanets=document.getElementById('tabPlanets');
const tabZoom=document.getElementById('tabZoom');
function showPlanetsTab(){ viewPlanets.classList.remove('hidden'); viewZoom.classList.add('hidden'); tabPlanets.classList.add('btn-primary'); tabZoom.classList.remove('btn-primary'); }
function showZoomTab(){ viewZoom.classList.remove('hidden'); viewPlanets.classList.add('hidden'); tabZoom.classList.add('btn-primary'); tabPlanets.classList.remove('btn-primary'); ensureViewer(); loadLayer(lastLayer); }
tabPlanets.addEventListener('click', showPlanetsTab);
tabZoom.addEventListener('click', showZoomTab);

let viewer=null; let lastLayer='earth';
function ensureViewer(){ if(viewer) return viewer; viewer=OpenSeadragon({ id:'viewer', prefixUrl:'https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.1/images/', showNavigator:true, maxZoomPixelRatio:4, showRotationControl:false, gestureSettingsMouse:{ clickToZoom:true, dblClickToZoom:true } }); return viewer; }
const DZ_SOURCES={
  earth:{type:'image',url:'https://upload.wikimedia.org/wikipedia/commons/8/86/Blue_Marble_2002.png'},
  mars:{type:'image',url:'https://upload.wikimedia.org/wikipedia/commons/0/02/Mars_Viking_MDIM21_1km_plus_poles.jpg'},
  moon:{type:'image',url:'https://upload.wikimedia.org/wikipedia/commons/5/5e/Moon_map_LRO_WAC_Poles_1k.jpg'}
};
function loadLayer(key){ lastLayer=key; ensureViewer().open(DZ_SOURCES[key]); }

// ---------- OPTIONAL: Tiny Texture Check Panel (remove later) ----------
(function(){
  const base = location.origin + location.pathname.replace(/\/[^\/]*$/, '/');
  const needed = ["mercury","venus","earth","moon","mars","jupiter","saturn","uranus","neptune"];
  const box = document.createElement('div');
  box.style.cssText='position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,.7);color:#fff;padding:10px;border:1px solid #4b5563;border-radius:10px;font:12px system-ui;z-index:99999;';
  box.innerHTML = '<b>Texture Check</b><div id="tc"></div>'; document.body.appendChild(box);
  const list = box.querySelector('#tc');
  (async () => {
    for (const n of needed) {
      const url = base + 'images/' + n + '.jpg';
      try {
        const r = await fetch(url, { cache:'no-store' });
        const ok = r.ok && (r.headers.get('content-type')||'').startsWith('image/');
        const line = document.createElement('div');
        line.innerHTML = (ok ? '‚úÖ' : '‚ùå') + ' ' + n + ' ‚Üí ' + '<a href="'+url+'" target="_blank" style="color:#93c5fd;text-decoration:underline;">images/'+n+'.jpg</a>';
        list.appendChild(line);
      } catch(e){
        const line = document.createElement('div');
        line.innerHTML = '‚ùå ' + n + ' ‚Üí images/'+n+'.jpg (fetch error)';
        list.appendChild(line);
      }
    }
  })();
})();
</script>

<!-- Start at Home; auto-focus default planet on load -->
<script>
showSection('home');
window.addEventListener('load', ()=>{ const mesh = (window.planetMeshesByName||{})[document.getElementById('bodySelect').value]; if(mesh) onSelectBody(mesh); });
</script>
</body>
</html>

